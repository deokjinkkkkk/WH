<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/index}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body layout:fragment="content">
	<section class="page-title-section bg-img cover-background"
		th:style="|background: url('img/banner/bg4.jpg')|">
		<h1 class="text-white font-weight-600">Tour Listing</h1>
		<ul>
			<li><a href="index.html">Home</a></li>
			<li><span class="active">Tour Listing</span></li>
		</ul>
	</section>
	<!--  start comment-->
	<section class="blogs">
		
			<div class="posts">
				<div class="container">
					<div class="row">
						<div
							class="col-lg-8 col-md-12 sm-margin-40px-bottom xs-margin-35px-bottom">
							<div class="posts">
								<div class="comments-area">
									<!--<div class="title-g margin-30px-bottom">
										<h3>Comments</h3>
									</div>
									 <div class="comment-box" 
							th:each=" c : ${com}"
							th:data-comcode="${c.comCode}">
							<div class="author-thumb">
								<img src="img/blog/01.png" alt="" class="rounded-circle width-85px width-100px" />
							</div>
							<div class="comment-info">
								<h6>
									<a href="javascript:void(0);" th:text="${c.name}"></a>
								</h6>
								<p th:text="${c.comContent}"></p>
									<button type="button" class="btnDel" onclick="comDelete()">삭제</button>
								<div class="reply">
									<a href="javascript:void(0);"> <i class="fa fa-reply"
										aria-hidden="true"></i> 답글
									</a>
								</div>
							</div>
							<input type="hidden" id="comCode" name="comCode"> 
						</div> -->
								</div>
								<!--  start form-->

								<div class="comment-form">
									<form id='comment-form' method='post'>
										
										<div class="controls">
											<div class="row">
												<input type="hidden" name="id" value="USER" id="id">
												<div class="col-md-12 form-group">
													<textarea id="comContent" name="comContent"
														placeholder="댓글 내용" rows="4" required="required"></textarea>
												</div>
												<div class="col-md-12">
													<button type="button" id="butn" class="butn">
														<span>댓글 달기</span>
													</button>
												</div>
											</div>
										</div>
										<input type="hidden" id="comBoardCode" name="comBoardCode" value="1">
										<input type="hidden" id="comFlag" name="comFlag" value="WT">
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		
	</section>
	<!-- end comment-->
	<script>
	//댓글 번호 자동증가(시퀀스)
	//댓글 비밀 0=모두보기 ,댓글 비밀 1=비밀댓글
	//댓글 순서 1,2...(댓글달기로 작성시 1 고정 답글로 달시 자동증가)
	//댓글 계층 1(댓글),2(대댓글)
	//댓글 그룹 1,2...(댓글달기로 작성시 자동 증가)(시퀀스)(답글로 달시 댓글 번호다라가기)
	//게시물 구분 게시판공통코드(게시판 별 mapper에서 default로 넣기)
	//게시문 번호 게시판코드
	
	$(document).ready(function(){
		getComList()
	})
	
	$("#butn").click(function(){ //댓글 등록
		let comContent =$("#comContent").val();
		let comId =$("#id").val();
		let comOrder = 1
		let comBlock = 1
		let comFlag = $("#comFlag").val();
		let comBoardCode = $("#comBoardCode").val();
		let comLock = 1
	
		if(comId == ""){
			alert("로그인 후 이용하세요")
			return;
		}; // 로그인 안했을시 댓글 작성 x
		
		$.ajax({
			url:"/comInsert",
			type:"POST",
			data: JSON.stringify(
				{
					"comContent" :comContent,
					"id" :comId,
					"comLock" : comLock,
					"comOrder" : comOrder,
					"comFlag" : comFlag, //게시물 구분
					"comBoardCode" : comBoardCode// 게시물 번호


				}
			),
			contentType:'application/json',
			success : function(data){
				console.log("댓글등록")
				$("#comContent").val("")
				console.log("====")
				getComList()
			},
			error:function(){
				alert('등록실패');
			}
		});
	});
	
	function getComList(){ //댓글 리스트
		let str = '<div class="title-g margin-30px-bottom">'
			str +='<h3>댓글</h3>'
			str +='</div>'
		let comArea =$(".comments-area");
		$.ajax({
			url:"/comGetList",
			success : function(result){
				$(result).each(function(index,item){
					str += "<div class='comment-box' id='"+item.comCode+"'>"
					str += '<div class="author-thumb">'
					str += '<img src="img/blog/01.png" alt="" class="rounded-circle width-85px width-100px" /> </div>'
					str += '<div class="comment-info">'
					str += '<h6> <a href="javascript:void(0);" >'+item.name+' </a></h6>'
					str	+= '<p>'+item.comContent+'</p>'
					str += '<button type="button" class="btnDel" onclick="comDelete()">삭제</button>'
					str += '<button type="button" class="btnDel" onclick="comUpdate()">수정</button>'
					str += '<div class="reply">'
					str += '<a href="javascript:void(0);" onclick="comReply()"> <i class="fa fa-reply" aria-hidden="true"></i> 답글</a>' 
					str += '</div> </div> </div>'
					str += '<div class="rep-form" id="'+item.comCode+'" style="display:none">'
					str += 	'<form id="reply-form " method="post">'
					str +=  '<div class="controls">'
					str +=  '<div class="row">'
				  	str +=  '<input type="hidden" name="id" value="USER" id="id">'
				  	str += '<div class="col-md-12 form-group">'
				  	str += '<textarea id="comRep'+item.comCode+'" name="comContent"'
				  	str += 'placeholder="답글" rows="2" required="required"></textarea>'
					str +=	'</div>'	
					str += '<div class="col-md-12">'
					str += '<button type="button" id="reButn" class="reButn" onclick="comReplyInsert()"><span>답글등록</span>'
					str += '</button></div></div></div></form></div>'
				})
				comArea.html(str);
			}
		})
	}
	
	function comDelete(){ //댓글 삭제
		let comBox = $(event.target).closest(".comment-box")
		console.log($(event.target).text())
		let comCode = comBox.attr('id')
		console.log(comCode)
		$.ajax({
			url:"/comDelete",
			type:"delete",
			data:
				{comCode}
			,
			success : function(data){
				console.log(data)
				comBox.remove();
			}
		})
	}
	
	function comReply(){ //답글창 on,off
		let comBox = $(event.target).closest(".comment-box")
		let recom = comBox.next()
		if(recom.is(':visible') != true){
			recom.show();	
		}else{
			recom.hide();
		}
	}
	//대댓글 댓글 그룹,  
	function comReplyInsert(){
		let rep = $(event.target).closest(".rep-form").attr('id')
		console.log(rep)
		
		$.ajax({
			url:"/comInsert",
			type:"POST",
			data: JSON.stringify(
				{
					"comContent" :comContent,
					"id" :comId
//					게시물 번호
//					댓글 비밀여부
				}
			),
			contentType:'application/json',
			success : function(data){
				console.log("댓글등록")
				$("#comContent").val("")
				console.log("====")
				getComList()
			},
			error:function(){
				alert('등록실패');
			}
		});
	}
</script>
</body>
</html>