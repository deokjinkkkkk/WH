<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{index}">




<body>
	<div layout:fragment="content" class="content">
<style>
 a { 
text-decoration-line: none; 
	color: black; 
 } 

/* .navbar { */
/* 	position: fixed; */
/* 	width: 100%; */
/* 	background-color: white; */
/* 	border-bottom: solid 1px rgb(202, 202, 202); */
/* } */

.container-fluid {
	justify-content: space-between;
	min-width: 1000px;
	text-align: center;
	width: 1000px;
	background-color: #FAFAFA;
	
}

/* .navbar-search { */
/* 	width: 300px; */
/* 	font-size: 14px; */
/* } */

.body {
	padding-top: 100px;
	display: flex;
	flex-direction: row;
	justify-content: center;
	font-size: 14px;
	background-color: #FAFAFA
}

.left-body {
	width: 630px;
	min-width: 630px;
	min-height: 1000px;
	margin-right: 350px;
}

.right-body {
	width: 320px;
	min-width: 320px;
	height: 1000px;
	position: fixed;
	margin-left: 650px;
}

/* .feed-box { */
/* 	border: solid 1px rgb(202, 202, 202); */
/* 	background-color: white; */
/* 	margin-bottom: 25px; */
/* } */

.profile {
	display: flex;
	flex-direction: row;
	align-items: center;
}

.profile-id {
	font-weight: bold;
}

.profile-name {
	font-size: 12px;
}

.profile-img-box {
	width: 40px;
	height: 40px;
	border-radius: 70%;
	overflow: hidden;
	margin: 10px;
	margin-right: 15px;
}

.profile-img {
	width: 100%;
	height: 100%;
	object-fit: cover;
}

.profile-text {
	flex-direction: column;
	text-align: left;
}

#feed-img {
	width: 100%;
}

.icon {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	margin: 10px;
	
}

.like {
	text-align: left;
	margin: 10px;
	font-size: 13px;
}

.feed-text {
	text-align: left;
	margin: 10px;
}

.comment {
	text-align: left;
	margin: 10px;
}

#input-comment {
	box-shadow: none;
	border: none;
	border-top: solid 1px rgb(202, 202, 202);
}

.recommend-msg {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	margin-left: 10px;
	font-weight: bold;
	margin-top: 10px;
	margin-bottom: 7px;
}

#recommend-text {
	color: grey;
}

#recommend-plus {
	text-decoration: none;
	color: black;
}

#follow {
	text-decoration: none;
	font-weight: bold;
	color: rgb(70, 156, 255);
}

.recommend-lst {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	align-items: center;
}

.information {
	color: rgb(197, 197, 197);
	font-size: 11px;
	margin-left: 10px;
	margin-top: 25px;
}

.modal_overlay {
	width: 100%;
	height: 100%;
	position: absolute;
	left: 0;
	top: 0;
	display: none;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	background: rgba(0, 0, 0, 0.8);
	backdrop-filter: blur(1.5px);
	-webkit-backdrop-filter: blur(1.5px);
}

.modal_window {
	background: white;
	backdrop-filter: blur(13.5px);
	-webkit-backdrop-filter: blur(13.5px);
	border-radius: 10px;
	border: 1px solid rgba(255, 255, 255, 0.18);
	width: 900px;
	height: 600px;
	position: relative;
	padding: 13px;
}

.modal_title {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	font-weight: bold;
	font-size: 20px;
}

.modal_title_side {
	flex: 0 0 40px;
	text-align: center;
}

.modal_image_upload {
	outline: 2px dashed black;
	outline-offset: -10px;
	text-align: center;
	transition: all .15s ease-in-out;
	width: 780px;
	height: 548px;
}

.main_body {
	display: flex;
	justify-content: center;
	padding-top: 50px;
	background-color: #FAFAFA;
}

.feed_box {
	background-color: white;
	width: 580px;
	margin: 10px;
	min-height: auto;
	padding-bottom: 10px;
}

.feed_img {
	width: 100%;
	object-fit: contain;
}

.feed_content {
	padding: 0px 10px;
}

.feed_like {
	padding: 0px 10px;
}

.feed_reply {
	padding: 0px 10px;
	display: flex;
	flex-direction: column;
}

.feed_txt {
	font-size: 14px;
}

.feed_icon {
	padding: 5px 5px 0px 5px;
	display: flex;
	justify-content: space-between;
}



.feed_name {
	padding: 10px;
	display: flex;
	align-items: center;
}

.feed_name_txt {
	font-size: 14px;
	padding: 0px 10px;
	font-weight: bold;
}

.profile_box {
	width: 40px;
	height: 40px;
	border-radius: 70%;
	overflow: hidden;
}

.profile_img {
	width: 100%;
	height: 100%;
	object-fit: cover;
}

.name_content {
	display: flex;
	flex-direction: column;
}

.name_content_txt {
	font-size: 12px;
	padding: 0px 10px;
	font-weight: bold;
	color: lightgray;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	width: 190px;
}

.big_profile_box {
	width: 60px;
	height: 60px;
	border-radius: 70%;
	overflow: hidden;
}

.link_txt {
	font-size: 14px;
	font-weight: bold;
	cursor: pointer;
	text-decoration: none;
}

.recommend_box {
	display: flex;
	justify-content: space-between;
	padding: 5px;
	font-size: 14px;
	font-weight: bold;
	align-items: center;
}

.comment_box {
	margin: 40px 0 0 5px;
	font-size: 12px;
	font-weight: bold;
	color: lightgray;
	display: flex;
	flex-direction: column;
}

@media screen and (max-width: 1280px) {
	.right_body {
		display: none;
	}
}



.modal_window {
	background: white;
	backdrop-filter: blur(13.5px);
	-webkit-backdrop-filter: blur(13.5px);
	border-radius: 10px;
	border: 1px solid rgba(255, 255, 255, 0.18);
	width: 1000px;
	height: 600px;
	position: relative;
}

.modal_title {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	font-weight: bold;
	font-size: 20px;
	border-bottom: 1px solid rgba(0, 0, 0, 0.18);
}

.modal_title_side {
	margin: 5px;
	flex: 0 0 40px;
	text-align: center;
}

.modal_image_upload {
	outline: 2px dashed black;
	outline-offset: -10px;
	transition: all .15s ease-in-out;
	width: 798px;
	height: 548px;
	text-align: center;
	line-height: 548px;
}

.modal_image_upload_content {
	outline: 2px dashed black;
	outline-offset: -10px;
	text-align: center;
	transition: all .15s ease-in-out;
	width: 500px;
	height: 548px;
}

.modal_image_content {
	display: flex;
	flex-direction: row;
}

.modal_content_write {
	display: flex;
	flex-direction: column;
	border-left: 1px solid rgba(0, 0, 0, 0.18);;
}

.feed_content_textarea {
	resize: none;
	width: 294px;
	border: none;
}

.col-sm-5 {
	width: 500px;
}

input[type='date']::before {
  content: attr(data-placeholder);
  width: 100%;
}

input[type='date']:focus::before,
input[type='date']:valid::before {
  display: none;
}
#input_content{
width: 400px;
}
</style>

		<!-- 배너시작 -->
		<section class="page-title-section bg-img cover-background"
			th:style="|background:url(/img/banner/bg2.jpg)|">
			<div class="container">

				<h1 class="text-white font-weight-600">여행리뷰</h1>
				<ul>
					<li><a href="/main">Home</a></li>
					<li><span class="active">여행리뷰</span></li>
				</ul>
			</div>
		</section>
		<!-- 배너종료 -->
		

	
      <div class="container-fluid">
         <a class="navbar-brand" href="#"> </a>
         <div class="navbar_icons">
            <a class="material-icons" href="/main"></a>
            <!-- 홈링크 걸기 -->
            <a class="material-icons-outlined"></a>
            <!-- 채팅기능 걸기 -->
            <span class="material-icons-outlined" id="add_feed">등록하기</span>
          
            <!-- 등록 -->
         </div>
      </div>


	<!-- 바디 영역 -->
	<div class="body">
	
		<div class="left-body">
			<div class="container">
		<div class="posts">
			<input type="hidden" name="id" th:value="${session.name}" id="id">
			<div class="feed-box">
			
			</div>
		</div>
		</div>
		<br> <br>
	</div>

	<!-- 공유하기 모달 시작  -->
	<form action="post" id="frm" enctype="multipart/form-data">
		<div id="modal_add_feed" class="modal modal_overlay">
			<div class="modal_window">
				<div class="modal_title">
					<div class="modal_title_side"></div>
					<div>새 게시물</div>
					<div class="modal_title_side">
						<span id="close_modal" class="close_modal material-icons-outlined"  data-dismiss="modal"
							style="font-size: 30px"> close </span>
					</div>
				</div>
				<div class="modal_image_upload" id="imgGroCode">
					<span style="text-align: center"> 사진을 여기에 끌어다 놓으세요. </span>
				</div>
				
				<div class="modal_image_content" style="display: none">
					<div id="input_image" class="modal_image_upload_content"></div>
					<div class="modal_content_write">
						<div class="feed_name">
							<span id="input_id" class="feed_name_txt"></span>
						</div>
						<div>
							<input type="text" id="diaryTitle" name="diaryTitle"
								class="feed_content_textarea form-control col-sm-5 diaryTitle" placeholder="제목을 입력해주세요." >
						</div>
						<div >
							<input type="date" data-placeholder="여행날짜 선택" required aria-required="true"   class="diaryStartDate" name="diaryStartDate" onChange={StartDateValueHandler} ></input>
							<input type="date" data-placeholder="여행종료날짜 선택" required aria-required="true"   class="diaryEndDate" name="diaryEndDate" onChange={StartDateValueHandler}></input>
						</div>
						<div style="height: 440px">
							<textarea id="input_content"
								class="feed_content_textarea form-control col-sm-5" rows="10"
								placeholder="설명을 입력하세요." name="diaryContent"></textarea>
						</div>
						<div style="width: 100%; text-align: center">
							<button id="button_write_feed" type="button"
								class="btn btn-primary" style="width: 268px">공유하기</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		
	<!-- 수정 창 HTML 코드 -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">수정</h5>
      	<span id="updateClose" class="close_modal material-icons-outlined" data-dismiss="modal"
							style="font-size: 30px"> close </span>					
      </div>
      <div class="modal-body">
        <div class="feed_name">
          <span id="input_id" class="feed_name_txt"></span>
        </div>
        <div>
          <input type="text" id="diaryTitleeee" name="diaryTitle" class="form-control col-sm-5 diaryTitle">
        </div>
        <div>
		<input type="date" data-placeholder="여행날짜 선택" required aria-required="true"   class="diaryStartDate" name="diaryStartDate" onChange={StartDateValueHandler} ></input>
		<input type="date" data-placeholder="여행종료날짜 선택" required aria-required="true"   class="diaryEndDate" name="diaryEndDate" onChange={StartDateValueHandler}></input>         
        </div>
        <div style="height: 440px">
          <textarea id="input_contenteeee"  class="form-control col-sm-5" rows="10" placeholder="설명을 입력하세요..." name="diaryContent"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="editDiaryBtn">수정하기</button>
      </div>
    </div>
  </div>
</div>
		
	</form>
	<!-- 공유하기 모달 종료  -->

	<script>

const modal = document.getElementById("modal_add_feed");
const id = $("#id").val();
const diaryCode = $(".diaryCode").val();


$(document).ready(function(){
	
	getDiaryList();
})
//리스트 출력
function getDiaryList() {
    var str = "";
    console.log(id)
    var diaryArea =$(".feed-box");
    $.ajax({
        url: "/getDiaryList/" + id,
        type: "GET",
        dataType: 'json',
        success: function (result) {
            //console.log("조회되나????????");
            $(result).each(function(index,item){
                if(id === item.id){ // diary -> item 수정
                    str += '<div class="diaryCode" style="border: 2px double black; background-color:white;   border-radius: 10px;" data-code="' + item.diaryCode + '">' 
                    str += '<div class="profile-id">' + item.id + '</div>' 
                    str += '<div class="feed-img">' 
                    str += '<img id="feed-img" style="width:400px;" src="/image/' + item.imgPath + '">'
                    str +='</div>'
                    str +='<div class="like" id="diaryStartDate">' + item.diaryStartDate + '</div>'
                    str +='<div class="like" id="diaryEndDate">' + item.diaryEndDate + '</div>'
                    str +='<br><br>'
                    str +='<h5><b><div class="feed-text" id="diarytitlet">' + item.diaryTitle + '</div></b></h5>'
                    str +='<div class="feed-text" id="diaryContent">' + item.diaryContent + '</div>' 
                    str +='<button type="button" class="btn btn-primary">수정</button>&nbsp;&nbsp;&nbsp;' 
                    str +='<button type="button" class="btn btn-danger" id="Delbtn">삭제</button>' 
                    str +='</div><br><br><br><br><br><br>'
                }
            });
            diaryArea.html(str);
        },
        error: function (error) {
            alert("조회실패"); 
        },
    });
}




//모달 열기
const buttonAddFeed = document.getElementById("add_feed");
buttonAddFeed.addEventListener("click", e => {
	$('#frm')[0].reset()
	$('.modal_image_upload').css({
        "background-color": "white",
        "outline-offset": "-10px"
    });
	  $('.modal_image_upload_content').css({
            "background-image": "",
            "outline": "none",
            "background-size": "contain",
            "background-repeat" : "no-repeat",
            "background-position" : "center"
        });
    $('.modal_image_content').hide();
    $('.modal_image_upload').show();
    modal.style.display = "flex";
    document.body.style.overflowY = "hidden"; // 스크롤 없애기
});


// 모달 닫기 코드
$('.close_modal').on("click", e => {
    modal.style.display = "none";
    document.body.style.overflowY = "visible";
});


//마우스를 놨을 때, 즉 drop 했을 때 실행되는 함수
$('.modal_image_upload')
    .on("dragover", dragOver)
    .on("dragleave", dragOver)
    .on("drop", uploadFiles);

function dragOver(e){
	 console.log(e);
    e.stopPropagation();
    e.preventDefault();
    
    if (e.type == "dragover") {
        $(e.target).css({
            "background-color": "black",
            "outline-offset": "-20px"
        });
    } else {
        $(e.target).css({
            "background-color": "white",
            "outline-offset": "-10px"
        });
    }
}

//파일 올릴때 
function uploadFiles(e){
    e.dataTransfer = e.originalEvent.dataTransfer;
    e.stopPropagation();
    e.preventDefault();
    console.log(e.dataTransfer)
    console.log(e.originalEvent.dataTransfer)


    files = e.dataTransfer.files;
    if (files.length > 1) {
        alert('하나만 올려주세요.');
        return;
    }

    if (files[0].type.match(/image.*/)) {
        $('.modal_image_content').show();
        $('.modal_image_upload').hide();
        $('.modal_image_upload_content').css({
            "background-image": "url(" + window.URL.createObjectURL(files[0]) + ")",
            "outline": "none",
            "background-size": "contain",
            "background-repeat" : "no-repeat",
            "background-position" : "center"
        });
    }else{
    	;
        alert('이미지가 아닙니다.');
        return;
    }
};





$('#button_write_feed').on('click', ()=>{
    const imgGroCode= $('#input_image').css("background-image").replace(/^url\(['"](.+)['"]\)/, '$1');
    const content = $('#input_content').val();
    const diaryTitle = $('.diaryTitle').val();
    const diaryContent = $('#input_content').val(); 
    const diaryStartDate = $(".diaryStartDate").val();
    const diaryEndDate = $(".diaryEndDate").val();
    const id = $("#id").val();

    if (!diaryTitle || !diaryContent || !diaryStartDate || !diaryEndDate) {
        swal("","모든 항목을 입력해주세요","warning");
        return;
    }
    
    const file = files[0];
    let fd = new FormData();

    //fd.append('file', file);
    fd.append('imgFile', file);
    fd.append('diaryTitle', diaryTitle);
    fd.append('diaryContent', diaryContent);
    fd.append('diaryStartDate', diaryStartDate)
    fd.append('diaryEndDate', diaryEndDate)
    fd.append('id', id);

 // FormData의 key 확인
    for (let key of fd.keys()) {
      console.log(key+"key값+++++++++++++++++++++");
    }

    // FormData의 value 확인
    for (let value of fd.values()) {
      console.log(value+"밸류=======================");
    }
 
    writeFeed(fd);
});


 function writeFeed(fd) {  //등록하는곳 
    $.ajax({
        url: "/diaryInsert",
        data: fd,
        method: "POST",
        processData: false,
        contentType: false,
        success: function (data) {
            console.log("성공");
            $('#modal_add_feed').hide()
            getDiaryList();
        },
        error: function (request, status, error) {
            console.log("에러");
        }
    })
};


//삭제
$(".feed-box").on('click',".btn-danger", ()=>{
	const par = $(event.target).parent()
    const diaryCode = $(event.target).parent().data('code');
    $.ajax({
        url: "/diaryDelete/"+ diaryCode + "/" + id,
        type: "POST",
        success: function (data) {
            console.log("성공");
        	par.remove();
        },
        error: function (request, status, error) {
            console.log("에러");
          
        }
    })
})



//수정
$(".feed-box").on("click", ".btn-primary", () => {
  const diaryCode = $(event.target).parent().data("code");
  const diaryTitle = $(event.target).parent().find(".feed-text#diarytitlet").text();
  const diaryContent = $(event.target).parent().find(".feed-text#diaryContent").text();
  const diaryStartDate = $(event.target).parent().find(".like#diaryStartDate").text();
  const diaryEndDate = $(event.target).parent().find(".like#diaryEndDate").text();
  
  const data = {
    diaryCode: diaryCode,
    diaryTitle: diaryTitle,
    diaryContent: diaryContent,
    diaryStartDate: diaryStartDate,
    diaryEndDate: diaryEndDate,
  };

  // 모달 창 띄우기
  $(".fade").modal('show');
 
  //모달창 x창 
  //$("#updateClose").hide();
  
  
  // 모달 창에 데이터 채우기
  $("#diaryTitleeee").val(diaryTitle);
  $(".diaryStartDateeee").val(diaryStartDate);
  $(".diaryEndDateeee").val(diaryEndDate);
  $("#input_contenteeee").val(diaryContent);



  
  
  // 모달 창에서 수정 버튼 클릭 시 서버에 데이터 보내기
  $(".modal-dialog").on("click",".btn-primary", () => {
    const newDiaryTitle = $("#diaryTitleeee").val();
    const newDiaryStartDate = $(".diaryStartDateeee").val();
    const newDiaryEndDate = $(".diaryEndDateeee").val();
    const newDiaryContent = $("#input_contenteeee").val();

    const newData = {
      diaryCode: diaryCode,
      diaryTitle: newDiaryTitle,
      diaryContent: newDiaryContent,
      diaryStartDate: newDiaryStartDate,
      diaryEndDate: newDiaryEndDate,
    };
    
   
    
    $.ajax({
      type: "POST",
      url: "/diaryUpdate/" + diaryCode + "/" + id,
      data: newData,
      success: function (response) {
        console.log("성공");
        $('#editModal').modal('hide')
        getDiaryList();
      },
      error: function (error) {
        console.log("에러");
      },
    });
  });
});




</script>
</div>
</div>
</body>
</html>