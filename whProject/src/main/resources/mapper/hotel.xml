<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.admin.wh.hotel.mapper.HotelMapper">

	<insert id="insertHotelInfo">
		<selectKey resultType="int" keyProperty="hotelId"
			order="BEFORE">
			SELECT NVL(MAX(hotel_Id),0)+1 FROM HOTEL
		</selectKey>
		insert into HOTEL
		values (#{hotelId}, #{hotelName}, #{star}, #{hotelAddr}, #{hotelInfo},
		#{hotelContent}, #{hotelRegion},#{roomGrade}, #{roomCount},
		#{roomPrice}, #{roomLimit}, #{img1}, #{img2},#{img3},#{img4},#{img5})
	</insert>

	<select id="hotelList" resultType="co.admin.wh.hotel.vo.HotelVO">
		SELECT * FROM( SELECT rownum rn, a.* FROM(
			SELECT h.HOTEL_ID, h.HOTEL_NAME, h.STAR, h.HOTEL_ADDR, h.HOTEL_INFO,
			h.HOTEL_CONTENT,
			h.HOTEL_REGION, h.ROOM_GRADE, h.ROOM_COUNT, h.ROOM_PRICE, h.ROOM_LIMIT,
			h.IMG1, h.IMG2, h.IMG3, h.IMG4, h.IMG5, COUNT(g.GREAT_N_CODE) as GREAT_COUNT
			FROM HOTEL h
			LEFT JOIN GREAT g
			ON h.HOTEL_ID = g.GREAT_N_CODE
			GROUP BY h.HOTEL_ID, h.HOTEL_NAME, h.STAR, h.HOTEL_ADDR, h.HOTEL_INFO,
			h.HOTEL_CONTENT,
			h.HOTEL_REGION, h.ROOM_GRADE, h.ROOM_COUNT, h.ROOM_PRICE, h.ROOM_LIMIT,
			h.IMG1, h.IMG2, h.IMG3, h.IMG4, h.IMG5
			ORDER BY GREAT_COUNT DESC
		<![CDATA[
		) a WHERE rownum <= #{last} ) b WHERE rn >= #{first}		
		]]>		
	</select>

	<select id="CrawlingList"
		resultType="co.admin.wh.hotel.vo.HotelVO">
		SELECT * FROM( SELECT rownum rn, a.* FROM(
			select a.*
			from (
			select * from hotel order by hotel_id desc) a
      	<![CDATA[
		) a WHERE rownum <= #{last} ) b WHERE rn >= #{first}		
		]]>	
	</select>
	
	<!-- 전체 건수 조회 -->
	<select id="getCountTotal" parameterType="co.admin.wh.hotel.vo.HotelSearchVO" resultType="int">
		SELECT COUNT(*) FROM HOTEL	
	</select>

	<select id="detailSelect"
		resultType="co.admin.wh.hotel.vo.HotelVO">
		select *
		from hotel
		where hotel_id = #{hotelId}
	</select>

	
	<insert id="insertReservInfo" parameterType="co.admin.wh.hotel.vo.ReservationVO">
	   	<selectKey resultType="int" keyProperty="resId" order="BEFORE">
	        SELECT NVL(MAX(res_Id),0)+1 FROM RESERVATION        
	    </selectKey>
		insert into Reservation
		values (#{resId},#{childCount},#{humanCount},#{resName},#{resTel},#{resEmail},#{resRequest},#{checkIn}+1,#{checkOut}+1,sysdate,#{totalPay},#{payState},#{hotelId},#{id},0)
	</insert>

	<select id="readReservInfo" resultType="co.admin.wh.hotel.vo.ReservationVO"
		parameterType="String">
		select r.*, h.*
		from Reservation r, Hotel h
		where id = #{sessionId}
	    and h.hotel_id = r.hotel_id
	    and r.res_state = 0
	</select>
	
	<select id="readCancelReservInfo" resultType="co.admin.wh.hotel.vo.ReservationVO"
		parameterType="String">
		select r.*, h.*
		from Reservation r, Hotel h
		where id = #{sessionId}
	    and h.hotel_id = r.hotel_id
	    and r.res_state = 1
	</select>
	
	<update id="hotelCancel" parameterType="co.admin.wh.hotel.vo.ReservationVO">
		update reservation
		<set>
			<if test="resState != null">res_state = 1</if>
		</set>
		where res_id=#{resId}
	</update>
	
	<update id="ReservUpdate" parameterType="co.admin.wh.hotel.vo.ReservationVO">
		update reservation
		<set>
			<if test="resName != null">res_name = #{resName},</if>
			<if test="resTel != null">res_tel = #{resTel},</if>
			<if test="resEmail != null">res_email = #{resEmail},</if>
			<if test="resRequest != null">res_request = #{resRequest}</if>
		</set>
		where res_id=#{resId}
	</update>
</mapper>